# Feature Specification: 代码库重构 - 模块化拆分与项目结构重组

**Feature Branch**: `001-refactor-codebase`
**Created**: 2025-01-13
**Status**: Draft
**Input**: User description: "目前 @git-webhooks-server.py 文件过大，应对文件进行拆分重构并重新对项目文件进行重新组织"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 代码导航与理解 (Priority: P1)

作为开发者，我希望能够快速定位和理解特定功能的代码实现，而不需要在一个超过1200行的单文件中搜索。

**Why this priority**: 这是核心开发体验问题。当前单文件架构严重影响了代码的可维护性和新开发者的上手速度。P1优先级因为这是所有其他开发活动的基础。

**Independent Test**: 可以通过测量开发者找到特定功能（如"Github签名验证逻辑"）所需时间来独立测试。重构后应能通过文件名和目录结构直接导航到相关代码。

**Acceptance Scenarios**:

1. **Given** 一个新加入项目的开发者，**When** 需要查找 Github webhook 处理逻辑，**Then** 应该能够通过目录结构（如 `handlers/github.py`）直接定位，无需搜索大文件
2. **Given** 现有代码库，**When** 需要修改签名验证逻辑，**Then** 应该能够在专门的验证模块（如 `auth/signature.py`）中找到相关代码
3. **Given** 重构后的代码库，**When** 打开任何模块文件，**Then** 文件长度应控制在合理范围（建议不超过300行）

---

### User Story 2 - 独立测试与验证 (Priority: P2)

作为开发者，我希望能够针对特定功能（如特定平台的webhook处理）编写和运行单元测试，而无需启动整个服务器。

**Why this priority**: 模块化后可以更容易地编写针对性的单元测试，提高代码质量和可靠性。P2因为虽然重要但不影响基本功能运行。

**Independent Test**: 可以独立测试单个模块的功能，例如仅测试签名验证逻辑，无需加载完整的HTTP服务器代码。

**Acceptance Scenarios**:

1. **Given** 重构后的代码库，**When** 运行 `pytest tests/test_signature_verification.py`，**Then** 应该能够测试所有签名验证相关的功能
2. **Given** 一个配置解析模块，**When** 编写测试用例，**Then** 应该能够独立导入和测试该模块，无需依赖其他模块
3. **Given** 分离的处理器模块，**When** 对 Github 处理器进行测试，**Then** 不应该因为 Gitee 或 Gitlab 处理器的问题而影响测试结果

---

### User Story 3 - 功能扩展与维护 (Priority: P3)

作为开发者，我希望添加新的 Git 平台支持时，只需要创建新的处理器模块并遵循现有接口，而不需要修改核心服务器代码。

**Why this priority**: 这展示了模块化架构的长期价值。P3因为当前主要目标是重构现有代码，扩展性是重构带来的自然结果。

**Independent Test**: 可以通过实际添加一个新的模拟平台支持来验证扩展能力，新增代码应该能无缝集成。

**Acceptance Scenarios**:

1. **Given** 重构后的代码库，**When** 添加新的 Git 平台支持（如 Bitbucket），**Then** 应该只需要创建新的处理器文件并在配置中注册
2. **Given** 现有的处理器接口，**When** 实现新的处理器，**Then** 应该能够继承基类并重写必要方法，无需了解其他处理器的实现
3. **Given** 模块化的配置系统，**When** 添加新的配置项，**Then** 应该能够在专门的配置模块中完成，不影响其他模块

---

### Edge Cases

- 当单个模块仍然过大时，如何进一步拆分？ → 按功能域进一步拆分子模块
- 如何处理模块间的循环依赖问题？ → **已解决**: 通过依赖注入模式消除全局状态，使用构造函数或方法参数传递配置
- 重构过程中如何确保现有功能不受影响？ → 通过完整测试套件验证（FR-007）
- 如何保证重构后的代码性能不低于重构前？ → 通过 T071 性能基准测试验证
- 一次性重写后如何确保所有边界情况和错误处理都被正确迁移？ → 通过 T069-T071 边界验证任务
- 如何验证迁移后的代码与原代码行为完全一致？ → 通过 100% 测试用例通过（SC-003）
- 如何确保依赖注入不会使代码过于复杂和难以使用？ → 通过构造函数注入保持简单，避免过度设计

### Performance Baseline

**当前性能基线**（从原代码测量）：
- 单个 webhook 请求处理时间：< 10ms（不含命令执行）
- 内存占用（运行时）：< 30MB
- 启动时间：< 100ms

**性能验证方法**（T071）：
使用相同测试负载（100个并发请求）比较重构前后的响应时间和内存占用

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须将当前的单文件（1200+行）拆分为多个功能模块，每个模块负责单一职责
- **FR-002**: 系统必须建立清晰的目录结构，采用包结构方式组织代码。详细的项目结构定义见 `plan.md` § Project Structure
- **FR-003**: 重构后的代码必须保持所有现有功能正常运行，包括对Github、Gitee、Gitlab和自定义平台的支持
- **FR-004**: 系统必须定义清晰的模块间接口，使模块之间的依赖关系单向且明确
- **FR-005**: 系统必须采用依赖注入模式来管理配置和依赖，通过构造函数或方法参数传递配置对象，消除全局状态
- **FR-006**: 重构必须保持与现有配置文件格式的完全兼容性
- **FR-007**: 系统必须保持现有测试套件的兼容性，采用完整测试套件验证策略：必须通过100%的现有测试用例才能完成迁移
- **FR-008**: 重构后的代码必须保留所有现有的错误处理和日志记录功能
- **FR-009**: 系统必须保持命令行参数和 API 接口的兼容性，通过提供新的 CLI 入口点（如 `gitwebhooks-cli`）来替代旧的 `git-webhooks-server.py` 脚本

### Key Entities

- **模块（Module）**: 独立的功能单元（Python 文件/包），包含相关的类、函数和常量。每个模块有明确的职责边界，如 `gitwebhooks/handlers/github.py` 是处理 Github webhook 的模块
- **数据类（Dataclass）**: 使用 `@dataclass` 装饰器定义的数据结构，用于封装相关数据。如 `ProviderConfig` 封装平台配置，`WebhookRequest` 封装请求数据
- **处理器（Handler）**: 负责处理特定Git平台webhook请求的组件类，每个处理器实现统一的 `WebhookHandler` 接口
- **验证器（Verifier）**: 负责验证webhook签名或令牌的组件类，支持多种验证策略
- **配置加载器（ConfigLoader）**: 负责从 INI 文件加载和解析配置的服务类
- **配置注册表（ConfigurationRegistry）**: 持有所有配置并提供统一访问接口的服务类

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 开发者能够在30秒内通过目录结构定位任何特定功能的代码实现（对比当前需要数分钟搜索大文件）。测量方法：计时测试，让开发者找到指定功能的代码位置
- **SC-002**: 任何单个模块文件的代码行数不超过400行（便于在一个屏幕内浏览和理解）。测量方法：使用 `wc -l` 统计，不含空行（或使用 `cloc --exclude-blank`）
- **SC-003**: 重构后的代码能够通过100%的现有测试用例，无功能回归
- **SC-004**: 新开发者能够在1小时内理解代码库的整体结构（对比当前需要3-4小时）。测量方法：新开发者阅读代码后通过面试验证理解程度
- **SC-005**: 添加新平台支持所需的代码变更范围减少50%（通过模块化接口实现）。测量方法：对比添加新平台（如 Bitbucket）需要修改的文件数量
- **SC-006**: 代码重复率降低到5%以下（通过模块化消除重复代码）。测量方法：使用 `cloc` 或类似工具计算重复代码比例
- **SC-007**: 单元测试覆盖率达到80%以上（模块化使测试更容易编写）。使用 Python 标准库 `trace` 模块测量：`python3 -m trace --count --coverdir=cover -m unittest discover tests/`

## Clarifications

### Session 2025-01-13

- Q: 项目结构策略（扁平结构 vs 包结构 vs 混合结构）？ → A: 包结构 - 创建 `gitwebhooks/` 主包，内部组织子模块（`gitwebhooks/handlers/`, `gitwebhooks/auth/` 等）
- Q: 迁移策略（渐进式迁移 vs 一次性重写 vs 并行开发）？ → A: 一次性重写 - 创建新的包结构，一次性迁移所有代码，删除原单文件
- Q: 测试验证策略（完整测试套件 vs 关键路径测试 vs 对比验证）？ → A: 完整测试套件验证 - 必须通过100%的现有测试用例才能完成迁移
- Q: 入口点兼容性（保留原入口脚本 vs 提供新入口点 vs 双入口点）？ → A: 提供新入口点 - 创建新的 CLI 入口（如 `gitwebhooks-cli`），废弃旧的脚本
- Q: 全局状态处理（保留全局变量 vs 依赖注入 vs 混合方式）？ → A: 依赖注入 - 通过构造函数或方法参数传递配置，消除全局状态

## Assumptions

- 保持Python 3.7+兼容性（使用 dataclass 需要 3.7+），不引入新的外部依赖
- 保持现有的INI配置文件格式和结构
- 保持现有的命令行接口和systemd服务集成方式
- 重构过程不影响生产环境的部署和运行
- 现有的测试套件可以作为重构的验证基准
- 用户接受暂时的API变更，只要功能保持兼容

## Dependencies

- 现有的测试套件必须能够运行，用于验证重构的正确性
- 安装脚本必须更新以安装新的 CLI 入口点（`gitwebhooks-cli`）而非旧的 `git-webhooks-server.py` 脚本
- systemd 服务配置需要更新以使用新的入口点
- 文档需要更新以反映新的项目结构、代码组织方式和入口点变更

## Out of Scope

- 不改变系统的核心功能逻辑
- 不引入新的webhook平台支持（这是重构后的自然结果，不是重构目标）
- 不改变配置文件的格式或结构
- 不改变HTTP服务器的接口和行为
- 不优化性能（虽然可能作为重构的副作用）
- 不迁移到其他编程语言或框架
